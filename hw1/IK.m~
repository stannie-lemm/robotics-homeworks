%%IK
function ik = IK(T0)
l0 = 670
l1 = 312
l2 = 1075
l3 = 225
l4 = 1280
l5 = 215
dl = sqrt(l3^2 + l4^2)
dq = atan2(l4, l3)

%% T123
T_base = Tz(l0); T_tool = Tx(l5)
T0_free = inv(T_base)*T0*inv(T_tool)
x = T0_free(1, 4); y = T0_free(2, 4); z = T0_free(3, 4)

% q1
q1 = atan2(y, x)

% q3 
Y = y/sin(q1) - l1
q3 = arccos((Y^2 + z^2 - dl^2 - l2^2)/(2*l2*dl)) - dq

% q2
a = -dl*sin(q3+dq); b = -dl*cos(q3+dq) - l2
len = sqrt(a^2 + b^2)
phi = atan2(a/len, b/len)
q2 = arcsin(z/len) - phi

% resulting T123
T123 = Rz(q1)*Tx(l1)*Ry(q2)*Tx(l2)*Ry(q3 + dq)*Tx(dl)*Ry(-dq)

%% T456

T456 = inv(T123)*T0_free
q456 =  E2A(T456)


ik = [q1, q2, q3, q456(1, 1), q456(1, 2), q456(1, 3);
      q1, q2, q3, q456(2, 1), q456(2, 2), q456(2, 3)]
end

function euler2angles = E2A(T456)
% for XYX euler

% normal angles
if (abs(T456(1, 1)) ~= 1) 
    q4 = atan2(T456(2, 1), -T456(3, 1))
    q5_1 = atan2(sqrt(T456(1, 2)^2 + T546(1, 3)^2), T456(1, 1))
    q5_2 = atan2(-sqrt(T456(1, 2)^2 + T546(1, 3)^2), T456(1, 1))
    q6 = atan2(T456(1, 2), T456(1, 3))

    euler2angles = [q4, q5_1, q6; q4, q5_2, q6]
end

% singular case 1
if (T456(1, 1) == 1)
    q46 = atan2(T456(2, 3), T456(2, 2))
    q4 = q46/2
    q5_1 = 0
    q5_2 = 2*pi
    q6 = q46/2
    
    euler2angles = [q4, q5_1, q6; q4, q5_2, q6]
end

% singular case 2
if (T456(1, 1) == -1)
    q46 = atan2(T456(2, 3), T456(2, 2))
    q4 = q46 + pi/10
    q5_1 = -pi
    q5_2 = pi
    q6 = pi/10
    
    euler2angles = [q4, q5_1, q6; q4, q5_2, q6]
end

end